---
phase: 05-tmdl-generation
plan: 02
type: tdd
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/semantic_model_generator/tmdl/generate.py
  - src/semantic_model_generator/tmdl/metadata.py
  - src/semantic_model_generator/tmdl/__init__.py
  - tests/tmdl/test_generate.py
  - tests/tmdl/test_metadata.py
autonomous: true

must_haves:
  truths:
    - "relationships.tmdl contains all inferred relationships with correct fromColumn/toColumn syntax"
    - "Inactive relationships have isActive: false property; active relationships omit it (default true)"
    - "Relationships are sorted: active first, then inactive, with secondary sort by table names"
    - ".platform JSON contains SemanticModel type, displayName, and deterministic logicalId"
    - "definition.pbism JSON contains correct schema URL and version"
    - "diagramLayout.json positions facts in left column, dimensions in rows above and below"
    - "Regenerating all files from identical input produces byte-identical output"
  artifacts:
    - path: "src/semantic_model_generator/tmdl/generate.py"
      provides: "relationships.tmdl generation function and top-level generate_all_tmdl orchestrator"
      exports: ["generate_relationships_tmdl", "generate_all_tmdl"]
    - path: "src/semantic_model_generator/tmdl/metadata.py"
      provides: "Metadata file generators for .platform, definition.pbism, diagramLayout.json"
      exports: ["generate_platform_json", "generate_definition_pbism_json", "generate_diagram_layout_json"]
    - path: "tests/tmdl/test_generate.py"
      provides: "Tests for relationships.tmdl generation and orchestrator"
    - path: "tests/tmdl/test_metadata.py"
      provides: "Tests for metadata file generators"
  key_links:
    - from: "src/semantic_model_generator/tmdl/generate.py"
      to: "src/semantic_model_generator/domain/types.py"
      via: "Relationship dataclass import for relationships.tmdl"
      pattern: "from semantic_model_generator\\.domain\\.types import.*Relationship"
    - from: "src/semantic_model_generator/tmdl/metadata.py"
      to: "src/semantic_model_generator/utils/uuid_gen.py"
      via: "generate_deterministic_uuid for platform logicalId"
      pattern: "from semantic_model_generator\\.utils\\.uuid_gen import"
    - from: "src/semantic_model_generator/tmdl/generate.py"
      to: "src/semantic_model_generator/tmdl/metadata.py"
      via: "generate_all_tmdl calls metadata generators"
      pattern: "from semantic_model_generator\\.tmdl\\.metadata import"
---

<objective>
Complete TMDL generation with relationships.tmdl, metadata files (.platform, definition.pbism, diagramLayout.json), and a top-level orchestrator that composes all generators into a complete semantic model output structure.

Purpose: This plan completes Phase 5 by adding the remaining TMDL file generators and a single orchestrator function that produces the full set of files as a dictionary (path -> content). The orchestrator ensures deterministic output order and validates all TMDL content.

Output: Complete TMDL generation capability with all required file types and deterministic output.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-tmdl-generation/05-CONTEXT.md
@.planning/phases/05-tmdl-generation/05-RESEARCH.md
@.planning/phases/05-tmdl-generation/05-01-SUMMARY.md
@src/semantic_model_generator/domain/types.py
@src/semantic_model_generator/tmdl/generate.py
@src/semantic_model_generator/tmdl/metadata.py
@src/semantic_model_generator/utils/whitespace.py
@src/semantic_model_generator/utils/identifiers.py
@src/semantic_model_generator/utils/uuid_gen.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED - Write failing tests for relationships TMDL, metadata files, and orchestrator</name>
  <files>
    tests/tmdl/test_generate.py
    tests/tmdl/test_metadata.py
    src/semantic_model_generator/tmdl/metadata.py
    src/semantic_model_generator/tmdl/generate.py
  </files>
  <action>
Add stubs for new functions to existing modules and write comprehensive tests.

**Add to `src/semantic_model_generator/tmdl/generate.py`** (append stubs):
- `generate_relationships_tmdl(relationships: Sequence[Relationship]) -> str` - raises NotImplementedError
- `generate_all_tmdl(model_name: str, tables: Sequence[TableMetadata], classifications: dict[tuple[str, str], TableClassification], relationships: Sequence[Relationship], key_prefixes: Sequence[str], catalog_name: str) -> dict[str, str]` - raises NotImplementedError. Returns dict mapping relative file paths to content strings (e.g., "definition/database.tmdl" -> content, "definition/tables/Customer.tmdl" -> content, ".platform" -> content, etc.)

**Create `src/semantic_model_generator/tmdl/metadata.py`** with stubs:
- `generate_platform_json(model_name: str) -> str` - raises NotImplementedError
- `generate_definition_pbism_json() -> str` - raises NotImplementedError
- `generate_diagram_layout_json(tables: Sequence[TableMetadata], classifications: dict[tuple[str, str], TableClassification]) -> str` - raises NotImplementedError

**Add tests to `tests/tmdl/test_generate.py`:**

Test `generate_relationships_tmdl`:
- Single active relationship: output contains `relationship {uuid}`, `fromColumn: '{from_table}'.{from_col}`, `toColumn: '{to_table}'.{to_col}`, NO `isActive` line (default is true)
- Inactive relationship: output contains `isActive: false`
- Multiple relationships sorted: active before inactive as primary sort, then by (from_table, from_column, to_table, to_column)
- Empty relationships list returns empty string
- Table names with special characters are properly escaped (single quotes doubled)
- Passes whitespace validation

Test `generate_all_tmdl`:
- Returns dict with all required file paths as keys:
  - ".platform"
  - "definition.pbism"
  - "definition/database.tmdl"
  - "definition/model.tmdl"
  - "definition/expressions.tmdl"
  - "definition/relationships.tmdl"
  - "definition/tables/{TableName}.tmdl" for each table
  - "diagramLayout.json"
- Each TMDL file value passes whitespace validation
- JSON files (.platform, definition.pbism, diagramLayout.json) are valid JSON (json.loads succeeds)
- Calling generate_all_tmdl twice with same input produces identical dict (determinism test)
- Test with 2 dimension tables and 1 fact table, 2 relationships

**Create `tests/tmdl/test_metadata.py`:**

Test `generate_platform_json`:
- Output is valid JSON (json.loads succeeds)
- Contains `$schema` key with fabric gitIntegration URL
- Contains metadata.type = "SemanticModel"
- Contains metadata.displayName = model_name argument
- Contains config.version = "2.0"
- Contains config.logicalId as a valid UUID string
- logicalId is deterministic (same model_name produces same UUID)
- Output is deterministic (sort_keys=True ensures stable JSON key order)

Test `generate_definition_pbism_json`:
- Output is valid JSON
- Contains `$schema` key with fabric semanticModel URL
- Contains `version` field (e.g., "4.2")
- Contains `settings` key (empty object)

Test `generate_diagram_layout_json`:
- Output is valid JSON
- Contains "tables" array
- Facts positioned in left column (all same x coordinate)
- Dimensions positioned in rows above facts (different y coordinates, different x from facts column)
- Each table entry has name, x, y, width, height fields
- Table count matches input table count (excluding unclassified)
- Deterministic: same input produces same output

Run `make check` - new tests FAIL (NotImplementedError), existing tests PASS.
  </action>
  <verify>
`make check` runs; new tests fail with NotImplementedError, all previously passing tests still pass.
  </verify>
  <done>Test files updated/created with comprehensive tests for relationships TMDL, metadata files, and orchestrator. All new tests fail (RED). All existing tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: GREEN - Implement relationships TMDL, metadata files, and orchestrator</name>
  <files>
    src/semantic_model_generator/tmdl/generate.py
    src/semantic_model_generator/tmdl/metadata.py
    src/semantic_model_generator/tmdl/__init__.py
  </files>
  <action>
Implement all remaining functions.

**`generate_relationships_tmdl(relationships: Sequence[Relationship]) -> str` in generate.py:**
- If empty, return empty string
- Sort relationships: active first (is_active=True before is_active=False), then by (from_table, from_column, to_table, to_column) per user decision
- For each relationship:
  - `relationship {rel.id}` (UUID as string)
  - If `is_active is False`: `{indent(1)}isActive: false` (omit for active, since true is default)
  - `{indent(1)}fromColumn: {quote_tmdl_identifier(from_table_name)}.{from_column}` -- Note: in TMDL relationship syntax, table name portion is quoted with single quotes, column is not. Format: `'TableName'.ColumnName`. Extract table name from schema-qualified "schema.table" by taking just the table part for the TMDL reference.
  - `{indent(1)}toColumn: {quote_tmdl_identifier(to_table_name)}.{to_column}`
  - Blank line between relationships
- IMPORTANT: The fromColumn/toColumn syntax in TMDL uses the table name (not schema-qualified) with column. The Relationship.from_table is schema-qualified "dbo.FactSales". Extract table_name part after the dot for the TMDL output. If the table name contains special chars, quote it.
- Validate with validate_tmdl_indentation before returning.

**`generate_platform_json(model_name: str) -> str` in metadata.py:**
- Use json.dumps with indent=2 and sort_keys=True for deterministic output
- Structure from research:
```json
{
  "$schema": "https://developer.microsoft.com/json-schemas/fabric/gitIntegration/platformProperties/2.0.0/schema.json",
  "config": {
    "logicalId": "{deterministic_uuid('platform', model_name)}",
    "version": "2.0"
  },
  "metadata": {
    "displayName": "{model_name}",
    "type": "SemanticModel"
  }
}
```
- logicalId via `generate_deterministic_uuid("platform", model_name)` - convert UUID to string.

**`generate_definition_pbism_json() -> str` in metadata.py:**
- Static JSON structure from research:
```json
{
  "$schema": "https://developer.microsoft.com/json-schemas/fabric/item/semanticModel/definitionProperties/1.0.0/schema.json",
  "settings": {},
  "version": "4.2"
}
```
- Use json.dumps with indent=2 and sort_keys=True for determinism.

**`generate_diagram_layout_json(tables, classifications) -> str` in metadata.py:**
- Per user decision: facts in left column, dimensions as rows above and below facts
- Hardcoded layout algorithm per user decision (not configurable):
  - table_width = 220, table_height = 140, x_gap = 40, y_gap = 40
  - Sort tables: dimensions first by (schema, table), then facts by (schema, table)
  - Facts: place vertically in left column (x=0, y increments by table_height + y_gap)
  - Dimensions: place in rows to the right of facts. Start at x = table_width + x_gap. Layout dimensions in a grid: e.g., 3 columns of dimensions, wrapping rows. Or simpler: place dimensions horizontally in a row above facts (y = -(table_height + y_gap)), wrapping to a second row below facts if needed.
  - Simpler approach matching reference notebook: dimensions horizontal (incrementing x), facts vertical column to the right.
  - Use the same pattern as reference notebook: dims horizontal row, facts vertical column offset to the right.
- Each table entry: `{"name": table_name, "x": x, "y": y, "width": table_width, "height": table_height}`
- Top-level: `{"version": 1, "tables": [...]}`
- Use json.dumps with indent=2 and sort_keys=True for determinism.

**`generate_all_tmdl(model_name, tables, classifications, relationships, key_prefixes, catalog_name) -> dict[str, str]`:**
- This is the orchestrator. It calls all individual generators and assembles the output.
- Sort tables for processing: dimensions first, then facts, within each by (schema_name, table_name) per user decision.
- Build the output dict:
  - `".platform"` -> `generate_platform_json(model_name)`
  - `"definition.pbism"` -> `generate_definition_pbism_json()`
  - `"definition/database.tmdl"` -> `generate_database_tmdl()`
  - `"definition/model.tmdl"` -> `generate_model_tmdl(model_name, table_qualified_names, classifications)`
  - `"definition/expressions.tmdl"` -> `generate_expressions_tmdl(catalog_name)`
  - `"definition/relationships.tmdl"` -> `generate_relationships_tmdl(relationships)`
  - For each table: `"definition/tables/{table.table_name}.tmdl"` -> `generate_table_tmdl(table, classification, key_prefixes, catalog_name)`
  - `"diagramLayout.json"` -> `generate_diagram_layout_json(tables, classifications)`
- Return the dict. All TMDL files are already validated by individual generators.

**Update `src/semantic_model_generator/tmdl/__init__.py`** to export all public functions from both generate.py and metadata.py.

Run `make check` - ALL tests should PASS (GREEN).
  </action>
  <verify>
`make check` passes. All tests pass (GREEN). Total test count increased significantly from plan 05-01 baseline.
  </verify>
  <done>All TMDL generation functions implemented: relationships.tmdl, .platform, definition.pbism, diagramLayout.json, and generate_all_tmdl orchestrator. All generated content passes validation. Deterministic output verified. Complete TMDL folder structure can be generated from schema metadata and relationships.</done>
</task>

</tasks>

<verification>
1. `make check` passes (lint + typecheck + test)
2. All new tests pass covering relationships TMDL, metadata files, orchestrator, and determinism
3. All existing tests still pass
4. `python -c "from semantic_model_generator.tmdl import generate_all_tmdl, generate_relationships_tmdl"` succeeds
5. `python -c "from semantic_model_generator.tmdl.metadata import generate_platform_json, generate_definition_pbism_json, generate_diagram_layout_json"` succeeds
6. Determinism test: generate_all_tmdl called twice with same input produces identical dict
</verification>

<success_criteria>
- relationships.tmdl correctly formats all relationships with TMDL fromColumn/toColumn syntax
- Active relationships sorted before inactive; within group sorted by table/column names
- .platform JSON has correct schema, SemanticModel type, deterministic logicalId
- definition.pbism JSON has correct schema and version
- diagramLayout.json positions tables with facts in column, dimensions in rows
- generate_all_tmdl produces complete dict with all required file paths
- All output is deterministic (identical on repeated calls)
- All TMDL content passes whitespace validation (tabs only)
</success_criteria>

<output>
After completion, create `.planning/phases/05-tmdl-generation/05-02-SUMMARY.md`
</output>
