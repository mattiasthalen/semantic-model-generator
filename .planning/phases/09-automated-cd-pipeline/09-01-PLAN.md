---
phase: 09-automated-cd-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/publish.yml
autonomous: false
user_setup:
  - service: pypi
    why: "OIDC Trusted Publishing requires PyPI project owner to configure trusted publisher"
    dashboard_config:
      - task: "Add trusted publisher for GitHub Actions"
        location: "pypi.org -> Project -> Settings -> Publishing -> Add new publisher"
        details: "Owner: <github-owner>, Repository: semantic-model-generator, Workflow: publish.yml, Environment: (leave blank)"

must_haves:
  truths:
    - "Pushing a v* tag to main triggers the publish workflow automatically"
    - "Quality gates (make check) run on Python 3.11 and 3.12 before any publish step"
    - "Workflow builds both wheel and sdist and verifies wheel installation"
    - "Package publishes to PyPI via OIDC Trusted Publishing (no API tokens)"
    - "GitHub release is created with changelog from MILESTONES.md, PyPI link, and MILESTONES.md link"
    - "Pre-release tags (rc, beta, alpha) are marked as pre-releases in GitHub"
    - "Manual workflow_dispatch trigger is available for reruns"
  artifacts:
    - path: ".github/workflows/publish.yml"
      provides: "Complete CD pipeline workflow"
      min_lines: 100
      contains: "pypa/gh-action-pypi-publish"
  key_links:
    - from: ".github/workflows/publish.yml (validate job)"
      to: "make check"
      via: "matrix strategy with Python 3.11 and 3.12"
      pattern: "make check"
    - from: ".github/workflows/publish.yml (build job)"
      to: "python -m build"
      via: "PyPA build frontend"
      pattern: "python -m build"
    - from: ".github/workflows/publish.yml (publish job)"
      to: "pypi.org"
      via: "OIDC trusted publishing action"
      pattern: "pypa/gh-action-pypi-publish"
    - from: ".github/workflows/publish.yml (release job)"
      to: "GitHub Releases"
      via: "gh release create"
      pattern: "gh release create"
---

<objective>
Create the complete GitHub Actions CD workflow that triggers on v* tag pushes to main, runs quality gates, builds and verifies the package, publishes to PyPI via OIDC, and creates a GitHub release with changelog and links.

Purpose: Automate the entire release process so a developer only needs to push a version tag to produce a published PyPI package and GitHub release.
Output: `.github/workflows/publish.yml` — fully functional multi-job CD pipeline.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-automated-cd-pipeline/09-CONTEXT.md
@.planning/phases/09-automated-cd-pipeline/09-RESEARCH.md
@.github/workflows/ci.yml
@pyproject.toml
@Makefile
@.planning/MILESTONES.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create publish.yml CD workflow</name>
  <files>.github/workflows/publish.yml</files>
  <action>
Create `.github/workflows/publish.yml` with a multi-job workflow structured as follows:

**Workflow triggers:**
- `push.tags`: pattern `v*` (matches v0.2.0, v0.2.0-rc1, v0.2.0-beta1, etc.)
- `push.branches`: `[main]` (only main branch tags trigger)
- `workflow_dispatch`: empty (manual trigger for testing/republishing)

**Top-level permissions:**
- `contents: write` (needed for release creation)
- `id-token: write` (needed for OIDC Trusted Publishing)

**Job 1: `validate`**
- `runs-on: ubuntu-latest`
- `strategy.fail-fast: false` (let all versions complete for debugging, per context decision)
- `strategy.matrix.python-version: ['3.11', '3.12']`
- Steps:
  1. `actions/checkout@v4` with `fetch-depth: 0` (hatch-vcs needs full tag history)
  2. `actions/setup-python@v5` with matrix python-version
  3. Install: `pip install -e .` then `pip install ruff mypy pytest pytest-cov` (matches ci.yml pattern exactly, no dependency caching per context decision)
  4. Run: `make check`

**Job 2: `build`**
- `needs: [validate]`
- `runs-on: ubuntu-latest`
- Steps:
  1. `actions/checkout@v4` with `fetch-depth: 0`
  2. `actions/setup-python@v5` with `python-version: '3.12'`
  3. Install build tools: `pip install build twine`
  4. Build: `python -m build` (produces both wheel and sdist in dist/)
  5. Validate metadata: `twine check dist/*`
  6. `actions/upload-artifact@v4` with `name: distributions`, `path: dist/`

**Job 3: `verify`**
- `needs: [build]`
- `runs-on: ubuntu-latest`
- Per context: test wheel only, Linux only
- Steps:
  1. `actions/download-artifact@v4` with `name: distributions`, `path: dist/`
  2. `actions/setup-python@v5` with `python-version: '3.12'`
  3. Install wheel: `pip install dist/*.whl`
  4. Verify import and version: `python -c "from semantic_model_generator._version import __version__; print(f'Installed version: {__version__}')"` (simple import check per research recommendation)

**Job 4: `publish`**
- `needs: [verify]`
- `runs-on: ubuntu-latest`
- `if: github.event_name == 'push'` (skip on workflow_dispatch unless explicitly desired — but actually keep it for all triggers so workflow_dispatch can republish)
- Remove the `if` — publish on all triggers (workflow_dispatch is for republishing)
- `environment: pypi` (optional, but good practice for audit trail)
- Steps:
  1. `actions/download-artifact@v4` with `name: distributions`, `path: dist/`
  2. `pypa/gh-action-pypi-publish@release/v1` — no `with:` parameters needed, OIDC handles auth

**Job 5: `release`**
- `needs: [publish]`
- `runs-on: ubuntu-latest`
- `if: github.event_name == 'push'` (only create releases on tag push, not workflow_dispatch reruns)
- Steps:
  1. `actions/checkout@v4` (default shallow clone is fine, only need MILESTONES.md)
  2. `actions/download-artifact@v4` with `name: distributions`, `path: dist/`
  3. "Extract changelog" step (bash):
     - Extract the section from `.planning/MILESTONES.md` matching the tag version.
     - MILESTONES.md structure: sections start with `## v0.1.0 ...` headers. Extract everything between the matching `## vX.Y.Z` header and the next `## ` header (or end of file).
     - The tag is `${{ github.ref_name }}` (e.g., "v0.2.0"). Strip the leading "v" to match MILESTONES.md headers (which use "v0.1.0" format — actually the headers already include "v", so match directly).
     - Use sed/awk to extract. Fallback if section not found: generate default notes "Release $TAG. See [full milestone details](.planning/MILESTONES.md) for changes."
     - Append links section:
       ```
       ---
       **Links:**
       - [PyPI Package](https://pypi.org/project/semantic-model-generator/${TAG_WITHOUT_V}/)
       - [Full Milestone Details](https://github.com/${GITHUB_REPOSITORY}/blob/main/.planning/MILESTONES.md)
       ```
     - Write to `changelog.md` file
  4. "Detect pre-release" step:
     - Check if tag matches pre-release pattern: `[[ "${{ github.ref_name }}" =~ -(rc|beta|alpha) ]]`
     - Set output `is_prerelease=true/false`
  5. "Create GitHub release" step using `gh release create`:
     - `env: GH_TOKEN: ${{ github.token }}`
     - Command: `gh release create ${{ github.ref_name }} --title "${{ github.ref_name }}" --notes-file changelog.md dist/*`
     - Add `--prerelease` flag conditionally based on pre-release detection step output
     - Per context: Release title is just the tag (e.g., "v0.2.0")
     - Attach both wheel and sdist files from dist/

**Important details:**
- No `env:` for OIDC — the `pypa/gh-action-pypi-publish` action handles OIDC token exchange automatically
- No retry logic (per context: "just fail the workflow" on any failure)
- No notifications or draft releases on failure (per context)
- Package name on PyPI: `semantic-model-generator` (from pyproject.toml project.name)
  </action>
  <verify>
Validate the workflow file is valid YAML:
```bash
python -c "import yaml; yaml.safe_load(open('.github/workflows/publish.yml'))"
```
If PyYAML not available, use:
```bash
python -c "
import json, re
with open('.github/workflows/publish.yml') as f:
    content = f.read()
# Basic structural checks
assert 'on:' in content, 'Missing trigger config'
assert 'push:' in content, 'Missing push trigger'
assert 'tags:' in content, 'Missing tag trigger'
assert 'v*' in content, 'Missing v* pattern'
assert 'workflow_dispatch' in content, 'Missing manual trigger'
assert 'validate:' in content, 'Missing validate job'
assert 'build:' in content, 'Missing build job'
assert 'verify:' in content, 'Missing verify job'
assert 'publish:' in content, 'Missing publish job'
assert 'release:' in content, 'Missing release job'
assert 'make check' in content, 'Missing quality gates'
assert 'python -m build' in content, 'Missing build command'
assert 'pypa/gh-action-pypi-publish' in content, 'Missing PyPI publish action'
assert 'gh release create' in content, 'Missing release creation'
assert 'id-token: write' in content, 'Missing OIDC permission'
assert 'fetch-depth: 0' in content, 'Missing full history checkout'
assert 'fail-fast: false' in content, 'Missing fail-fast: false'
assert '3.11' in content and '3.12' in content, 'Missing Python version matrix'
assert 'MILESTONES.md' in content, 'Missing MILESTONES.md reference'
assert 'prerelease' in content.lower() or 'pre-release' in content.lower(), 'Missing pre-release detection'
print('All structural checks passed')
"
```
  </verify>
  <done>
`.github/workflows/publish.yml` exists with all 5 jobs (validate, build, verify, publish, release), correct trigger configuration (v* tags on main + workflow_dispatch), OIDC permissions, matrix strategy for Python 3.11/3.12, and changelog extraction from MILESTONES.md.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Configure PyPI Trusted Publishing</name>
  <action>
Human-only action: Configure OIDC Trusted Publishing on pypi.org. This cannot be automated — it requires logging into the PyPI web dashboard with the project owner's credentials.

1. Go to https://pypi.org and log in
2. Navigate to the `semantic-model-generator` project (create it first if it doesn't exist yet — OR configure a "pending publisher" at https://pypi.org/manage/account/publishing/)
3. Go to **Settings** -> **Publishing** -> **Add a new publisher**
4. Fill in:
   - **Owner:** Your GitHub username or org
   - **Repository name:** `semantic-model-generator`
   - **Workflow name:** `publish.yml`
   - **Environment:** Leave blank (unless you add a GitHub environment)
5. Click **Add**

**Note:** If the project doesn't exist on PyPI yet, use "pending publisher" at https://pypi.org/manage/account/publishing/ to configure the trust before the first publish.
  </action>
  <verify>
Push a test tag and confirm the workflow publishes to PyPI:
1. Create and push a test tag: `git tag v0.2.0 && git push origin v0.2.0`
2. Check GitHub Actions tab for the publish workflow run
3. Verify package appears on https://pypi.org/project/semantic-model-generator/
  </verify>
  <done>
PyPI Trusted Publisher is configured for the semantic-model-generator project, linking the GitHub repository's publish.yml workflow to PyPI's OIDC trust. The publish job can authenticate and upload without API tokens.
  </done>
</task>

</tasks>

<verification>
1. `.github/workflows/publish.yml` exists and is valid YAML
2. Workflow has 5 jobs in correct dependency chain: validate -> build -> verify -> publish -> release
3. Trigger config: `push.tags: [v*]` on `branches: [main]` + `workflow_dispatch`
4. Validate job: Python 3.11 + 3.12 matrix, `fail-fast: false`, `make check`
5. Build job: `python -m build` + `twine check` + artifact upload
6. Verify job: wheel installation + import check
7. Publish job: `pypa/gh-action-pypi-publish@release/v1` with OIDC
8. Release job: changelog extraction from MILESTONES.md, PyPI link, MILESTONES.md link, pre-release detection, `gh release create` with attached distributions
9. All checkout steps in validate/build use `fetch-depth: 0`
</verification>

<success_criteria>
- The workflow file passes YAML validation
- All 14 requirements (CICD-01, CICD-02, BUILD-01 through BUILD-06, PUB-01 through PUB-03, REL-01 through REL-04) are addressed by the workflow
- The workflow can be triggered by pushing a v* tag to main
- Quality gates, build, verification, publishing, and release creation are properly sequenced with job dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/09-automated-cd-pipeline/09-01-SUMMARY.md`
</output>
