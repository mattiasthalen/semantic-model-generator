---
phase: 03-schema-discovery-classification
plan: 03
type: gap_closure
wave: 3
depends_on: ["03-02"]
files_modified:
  - pyproject.toml
  - src/semantic_model_generator/schema/connection.py
  - tests/schema/test_connection.py
gap_closure: true
autonomous: true

must_haves:
  truths:
    - "Library uses mssql-python (not pyodbc) for Fabric warehouse connections"
    - "Connection uses Authentication=ActiveDirectoryDefault in connection string"
    - "ActiveDirectoryDefault leverages DefaultAzureCredential internally"
    - "Connection string excludes UID, PWD, Authentication when using token mode"
    - "Retry logic uses tenacity with exponential backoff on mssql_python exceptions"
    - "No manual UTF-16-LE token encoding required (handled by driver)"
    - "No unixodbc system libraries required (mssql-python has no external deps on Windows)"
    - "System libraries installed: libltdl7, libkrb5-3, libgssapi-krb5-2 (Linux/Debian)"
  artifacts:
    - path: "pyproject.toml"
      provides: "mssql-python dependency (replaces pyodbc)"
      contains: "mssql-python"
    - path: "src/semantic_model_generator/schema/connection.py"
      provides: "Connection factory using mssql-python with ActiveDirectoryDefault"
      exports: ["create_fabric_connection"]
    - path: "tests/schema/test_connection.py"
      provides: "Tests using mocked mssql_python.connect (not pyodbc)"
  key_links:
    - from: "src/semantic_model_generator/schema/connection.py"
      to: "mssql_python"
      via: "mssql_python.connect with connection string"
      pattern: "mssql_python\\.connect"
    - from: "src/semantic_model_generator/schema/discovery.py"
      to: "src/semantic_model_generator/schema/connection.py"
      via: "accepts mssql_python.Connection as parameter (duck typing)"
      pattern: "conn.*Connection"
---

<objective>
Migrate from pyodbc to mssql-python (Microsoft's official GA driver released January 2026). Replace manual token encoding with cleaner ActiveDirectoryDefault connection string authentication. Remove unixodbc dependency and install Linux-specific libraries (libltdl7, libkrb5-3, libgssapi-krb5-2).

Purpose: Use the modern, officially supported mssql-python driver instead of the older pyodbc + ODBC Manager approach. mssql-python uses DDBC (Direct Database Connectivity) with no external dependencies on Windows and cleaner Azure AD authentication.
Output: Updated connection.py and tests using mssql-python. Simplified connection logic (no manual token encoding).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-schema-discovery-classification/03-02-SUMMARY.md
@src/semantic_model_generator/schema/connection.py
@src/semantic_model_generator/schema/discovery.py
@tests/schema/test_connection.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace pyodbc with mssql-python in connection.py</name>
  <files>
    pyproject.toml
    src/semantic_model_generator/schema/connection.py
    tests/schema/test_connection.py
  </files>
  <action>
First, install system libraries for mssql-python on Linux (Debian/Ubuntu):
```bash
apt-get update && apt-get install -y libltdl7 libkrb5-3 libgssapi-krb5-2
```

Update pyproject.toml:
- Remove: `pyodbc>=5.0`
- Add: `mssql-python>=1.0.0`
- Remove mypy override for `pyodbc` (keep azure.* override)

Install new dependency:
```bash
pip install -e .
```

RED phase -- Update tests/schema/test_connection.py FIRST:

Remove all tests for:
- `encode_token_for_odbc` (no longer needed - driver handles token encoding)
- attrs_before parameter tests (different API)
- SQL_COPT_SS_ACCESS_TOKEN tests (internal to driver)

Replace with new tests:
1. Connection string format test:
   - Uses mssql_python.connect (not pyodbc.connect)
   - Connection string contains "Authentication=ActiveDirectoryDefault"
   - Connection string contains "Server", "Database", "Encrypt=Yes", "TrustServerCertificate=No"
   - Connection string does NOT contain UID or PWD

2. Retry test:
   - Mock mssql_python.connect to raise mssql_python.OperationalError
   - Verify retry with 3 attempts and exponential backoff

Use @patch("semantic_model_generator.schema.connection.mssql_python") to mock the driver.

Run tests -- they MUST fail.
Commit: "test(03-03): update connection tests for mssql-python"

GREEN phase -- Update src/semantic_model_generator/schema/connection.py:

Remove:
- `encode_token_for_odbc()` function (no longer needed)
- `import struct`, `from itertools import chain, repeat`
- `import pyodbc`
- `from azure.identity import DefaultAzureCredential` (driver handles this internally via ActiveDirectoryDefault)
- `_SQL_COPT_SS_ACCESS_TOKEN` constant
- `_TOKEN_SCOPE` constant

Replace with:
```python
"""Fabric warehouse connection factory using mssql-python.

Connects to Microsoft Fabric warehouses using mssql-python (Microsoft's official
Python driver released GA January 2026). Uses DDBC (Direct Database Connectivity)
instead of routing through ODBC Driver Manager.

Authentication via ActiveDirectoryDefault leverages DefaultAzureCredential internally,
supporting managed identity, CLI credentials, environment variables, etc.

References:
- https://learn.microsoft.com/en-us/fabric/database/sql/connect-python
- https://github.com/microsoft/mssql-python/wiki/Microsoft-Entra-ID-support
- https://pypi.org/project/mssql-python/
"""

import mssql_python
from tenacity import (
    retry,
    retry_if_exception_type,
    stop_after_attempt,
    wait_exponential,
)


@retry(
    retry=retry_if_exception_type((mssql_python.OperationalError, mssql_python.InterfaceError)),
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=1, min=2, max=10),
)
def create_fabric_connection(
    sql_endpoint: str,
    database: str,
) -> mssql_python.Connection:
    """Create authenticated connection to a Fabric warehouse.

    Uses ActiveDirectoryDefault authentication which internally leverages
    DefaultAzureCredential. Supports multiple credential sources:
    - Managed Identity (production Azure services)
    - Azure CLI (local development)
    - Environment variables (CI/CD pipelines)
    - Visual Studio Code
    - Azure PowerShell

    Args:
        sql_endpoint: Fabric SQL analytics endpoint (e.g., xxx.datawarehouse.fabric.microsoft.com)
        database: Database name in the warehouse

    Returns:
        Authenticated mssql_python Connection

    Raises:
        mssql_python.OperationalError: After 3 retry attempts on transient failures
        mssql_python.InterfaceError: Connection configuration errors
        azure.core.exceptions.ClientAuthenticationError: If no valid credential found
    """
    connection_string = (
        f"Server={sql_endpoint},1433;"
        f"Database={database};"
        "Authentication=ActiveDirectoryDefault;"
        "Encrypt=Yes;"
        "TrustServerCertificate=No"
    )

    return mssql_python.connect(connection_string)
```

Update schema/__init__.py:
- Remove: `encode_token_for_odbc` from imports and __all__
- Keep: `create_fabric_connection`

Run tests -- they MUST pass.
Run `make check` to confirm all green.
Commit: "feat(03-03): migrate from pyodbc to mssql-python"
  </action>
  <verify>
    1. `make test` passes with all connection tests green
    2. `make check` passes (lint + typecheck + test)
    3. `python -c "from semantic_model_generator.schema.connection import create_fabric_connection; print('OK')"` succeeds
    4. `python -c "import mssql_python; print('OK')"` succeeds
    5. pyodbc is NOT in dependencies (grep pyodbc pyproject.toml returns empty)
    6. mssql-python IS in dependencies (grep mssql-python pyproject.toml succeeds)
  </verify>
  <done>
    Connection factory now uses mssql-python with Authentication=ActiveDirectoryDefault connection string. No manual token encoding required. Driver internally uses DefaultAzureCredential for authentication. System libraries (libltdl7, libkrb5-3, libgssapi-krb5-2) installed for Linux. All tests pass with mocked mssql_python.connect.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update discovery.py to use mssql_python.Connection type hint</name>
  <files>
    src/semantic_model_generator/schema/discovery.py
    tests/schema/test_discovery.py
  </files>
  <action>
RED phase -- Update tests/schema/test_discovery.py FIRST:

Change mock import:
- From: `@patch("semantic_model_generator.schema.discovery.pyodbc")`
- To: `@patch("semantic_model_generator.schema.discovery.mssql_python")`

Note: The mock strategy remains the same - mock connection.cursor() and cursor.fetchall(). The API is compatible.

Run tests -- they should still pass (duck typing, no API changes needed).
If any failures, fix them.
Commit: "test(03-03): update discovery tests for mssql-python"

GREEN phase -- Update src/semantic_model_generator/schema/discovery.py:

Change import:
- From: `import pyodbc`
- To: `import mssql_python`

Change type hint in discover_tables signature:
- From: `conn: pyodbc.Connection`
- To: `conn: mssql_python.Connection`

Update docstring:
- From: "Authenticated pyodbc connection to Fabric warehouse"
- To: "Authenticated mssql_python connection to Fabric warehouse"

Run tests -- they MUST pass.
Run `make check` to confirm all green.
Commit: "feat(03-03): update discovery to use mssql_python connection type"
  </action>
  <verify>
    1. `make test` passes with all discovery tests green
    2. `make check` passes (lint + typecheck + test)
    3. discovery.py imports mssql_python (not pyodbc)
    4. Type hints use mssql_python.Connection
    5. All 11 discovery tests still pass (API compatible)
  </verify>
  <done>
    discovery.py now uses mssql_python.Connection type hint. Tests updated to mock mssql_python instead of pyodbc. All tests pass - the cursor API is compatible between drivers (fetchall, execute, etc.).
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `make check` passes with zero errors
2. pyodbc is completely removed from codebase (no imports, no dependencies)
3. mssql-python is in pyproject.toml dependencies
4. All connection tests pass (simplified, no manual token encoding tests)
5. All discovery tests pass (mocked mssql_python)
6. `mypy src/` passes in strict mode
7. connection.py uses mssql_python.connect with Authentication=ActiveDirectoryDefault
8. No encode_token_for_odbc function exists
9. System libraries installed: libltdl7, libkrb5-3, libgssapi-krb5-2
10. No unixodbc dependency
</verification>

<success_criteria>
- create_fabric_connection uses mssql_python.connect (not pyodbc.connect)
- Connection string includes "Authentication=ActiveDirectoryDefault"
- ActiveDirectoryDefault internally uses DefaultAzureCredential (no manual token handling)
- Connection string excludes UID and PWD
- Retry logic: 3 attempts with exponential backoff on mssql_python.OperationalError
- discover_tables accepts mssql_python.Connection parameter
- All tests use mocked mssql_python (not pyodbc)
- pyodbc completely removed from dependencies
- mssql-python>=1.0.0 added to dependencies
- Linux system libraries installed (libltdl7, libkrb5-3, libgssapi-krb5-2)
- No unixodbc dependency
- make check passes (lint + typecheck + test)
</success_criteria>

<output>
After completion, create `.planning/phases/03-schema-discovery-classification/03-03-SUMMARY.md`
</output>
