---
phase: 06-output-layer
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/semantic_model_generator/output/__init__.py
  - src/semantic_model_generator/output/watermark.py
  - tests/output/__init__.py
  - tests/output/test_watermark.py
autonomous: true

must_haves:
  truths:
    - "TMDL files get a triple-slash (///) watermark header with generator name, version, and UTC timestamp"
    - "JSON files get a _comment field watermark with generator name, version, and UTC timestamp"
    - "Files containing 'semantic-model-generator' are detected as auto-generated"
    - "Files without 'semantic-model-generator' are detected as manually maintained"
    - "WriteSummary frozen dataclass reports written, skipped, unchanged, and output_path"
    - "Atomic file writing uses tempfile in same directory + os.replace for crash safety"
  artifacts:
    - path: "src/semantic_model_generator/output/__init__.py"
      provides: "Module exports for watermark and writer functions"
      contains: "from semantic_model_generator.output.watermark import"
    - path: "src/semantic_model_generator/output/watermark.py"
      provides: "Watermark generation, detection, atomic file writing, WriteSummary type"
      exports: ["generate_watermark_tmdl", "generate_watermark_json", "is_auto_generated", "add_watermark_to_content", "write_file_atomically", "WriteSummary"]
    - path: "tests/output/test_watermark.py"
      provides: "Tests for all watermark functions and atomic writing"
      min_lines: 80
  key_links:
    - from: "src/semantic_model_generator/output/watermark.py"
      to: "semantic_model_generator._version"
      via: "import __version__ for watermark version string"
      pattern: "from semantic_model_generator._version import"
    - from: "src/semantic_model_generator/output/watermark.py"
      to: "tempfile + os.replace"
      via: "atomic file writing pattern"
      pattern: "tempfile\\.mkstemp.*os\\.replace"
---

<objective>
Watermark generation, detection, atomic file writing, and WriteSummary result type for the TMDL output layer.

Purpose: Establishes the building blocks for Phase 6 file writing -- watermarks identify auto-generated files for safe overwriting, atomic writes prevent corruption, and WriteSummary provides structured feedback on what changed.
Output: `output/watermark.py` module with watermark generation (TMDL and JSON), detection (`is_auto_generated`), atomic file writing, and `WriteSummary` frozen dataclass. Full TDD test suite.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-output-layer/06-CONTEXT.md
@.planning/phases/06-output-layer/06-RESEARCH.md
@src/semantic_model_generator/_version.py
@src/semantic_model_generator/domain/types.py
</context>

<feature>
  <name>Watermark Generation, Detection, Atomic File Writing, and WriteSummary</name>
  <files>
    src/semantic_model_generator/output/__init__.py
    src/semantic_model_generator/output/watermark.py
    tests/output/__init__.py
    tests/output/test_watermark.py
  </files>
  <behavior>
    Watermark generation for TMDL files:
    - generate_watermark_tmdl(version: str, timestamp: str | None = None) -> str
    - Returns multi-line triple-slash (///) comment block
    - Header contains "semantic-model-generator", version, and UTC timestamp
    - If timestamp is None, uses current UTC time; if provided, uses that (for deterministic testing)
    - Format: "/// Auto-generated by semantic-model-generator v{version}\n/// Generated: {timestamp}\n/// DO NOT EDIT - remove this header to protect from regeneration\n"

    Watermark generation for JSON content:
    - generate_watermark_json(version: str, timestamp: str | None = None) -> str
    - Returns a _comment JSON field value string (not the whole JSON, just the value)
    - Contains "semantic-model-generator", version, and UTC timestamp
    - Format: "Auto-generated by semantic-model-generator v{version} at {timestamp}. DO NOT EDIT - remove this field to protect from regeneration."

    Add watermark to content:
    - add_watermark_to_content(filename: str, content: str, version: str, timestamp: str | None = None) -> str
    - For .tmdl files: prepends triple-slash watermark header before content
    - For .json files: parses JSON, inserts _comment field as first key, re-serializes with indent=2
    - For .pbism files: same as .json (they are JSON format)
    - For .platform files: same as .json (they are JSON format)
    - For unknown extensions: prepends TMDL-style watermark (safe default)

    Watermark detection:
    - is_auto_generated(content: str) -> bool
    - Returns True if "semantic-model-generator" appears anywhere in content
    - Simple string containment per user decision (NOT regex)
    - Empty string returns False

    WriteSummary result type:
    - Frozen dataclass with slots=True (follows project convention)
    - Fields: written (tuple[str, ...]), skipped (tuple[str, ...]), unchanged (tuple[str, ...]), output_path (Path)
    - written = files that were created or overwritten (had watermark or didn't exist)
    - skipped = files that existed without watermark (manually maintained)
    - unchanged = files where new content is byte-identical to existing content

    Atomic file writing:
    - write_file_atomically(path: Path, content: str) -> None
    - Creates parent directories if needed (Path.mkdir(parents=True, exist_ok=True))
    - Uses tempfile.mkstemp(dir=path.parent) for same-filesystem temp file
    - Writes with encoding='utf-8', newline='\n'
    - Uses os.replace() for atomic swap
    - Cleans up temp file on error (try/except with os.unlink)

    Test cases:
    - generate_watermark_tmdl returns triple-slash header with version and timestamp
    - generate_watermark_tmdl with explicit timestamp is deterministic
    - generate_watermark_tmdl without timestamp uses current UTC time
    - generate_watermark_json returns _comment value with version and timestamp
    - add_watermark_to_content for .tmdl prepends header before content
    - add_watermark_to_content for .json inserts _comment as first field
    - add_watermark_to_content for .pbism inserts _comment as first field
    - add_watermark_to_content for .platform inserts _comment as first field
    - is_auto_generated returns True for content containing "semantic-model-generator"
    - is_auto_generated returns False for content without watermark
    - is_auto_generated returns False for empty string
    - WriteSummary is frozen (immutable)
    - WriteSummary has correct fields
    - write_file_atomically creates file with correct content
    - write_file_atomically creates parent directories
    - write_file_atomically uses UTF-8 encoding and LF newlines
    - write_file_atomically cleans up temp file on write error
  </behavior>
  <implementation>
    Create src/semantic_model_generator/output/__init__.py exporting all public names from watermark.py.
    Create src/semantic_model_generator/output/watermark.py with all functions above.
    Use datetime.now(timezone.utc).strftime("%Y-%m-%dT%H:%M:%SZ") for timestamps.
    Use json.loads/json.dumps for JSON watermark injection (parse existing content, add _comment key first, re-serialize).
    Follow project conventions: frozen=True, slots=True for dataclasses; functional style; explicit types.
    Version string comes from semantic_model_generator._version.__version__ at runtime, but functions accept it as parameter for testability.
  </implementation>
</feature>

<verification>
```bash
cd /workspaces/semantic-model-generator && python -m pytest tests/output/test_watermark.py -v
cd /workspaces/semantic-model-generator && make check
```
All new tests pass. All existing 256 tests still pass. Lint + typecheck clean.
</verification>

<success_criteria>
- generate_watermark_tmdl produces valid triple-slash comment block with version and timestamp
- generate_watermark_json produces _comment value string with version and timestamp
- add_watermark_to_content correctly prepends/injects watermark based on file extension
- is_auto_generated detects "semantic-model-generator" via simple string containment
- WriteSummary is frozen dataclass with written, skipped, unchanged, output_path fields
- write_file_atomically uses tempfile + os.replace for crash-safe atomic writes
- All tests pass, make check clean
</success_criteria>

<output>
After completion, create `.planning/phases/06-output-layer/06-01-SUMMARY.md`
</output>
