---
phase: 06-output-layer
plan: 02
type: tdd
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/semantic_model_generator/output/writer.py
  - src/semantic_model_generator/output/__init__.py
  - tests/output/test_writer.py
autonomous: true

must_haves:
  truths:
    - "Generated TMDL dict is written to correct folder structure on disk (definition/ subdirectory for .tmdl, root for .pbism/.platform)"
    - "Files containing the generator watermark are overwritten on regeneration"
    - "Files without the watermark are preserved untouched and reported as skipped"
    - "Extra files on disk not in generated set are left untouched (not deleted)"
    - "Dev mode (default) creates folder with UTC timestamp suffix: ModelName_20260210T120000Z"
    - "Prod mode writes to base model name folder and errors if folder exists without overwrite=True"
    - "Writer returns WriteSummary with accurate lists of written, skipped, and unchanged files"
    - "Output directory is created automatically if it does not exist"
  artifacts:
    - path: "src/semantic_model_generator/output/writer.py"
      provides: "write_tmdl_folder function, get_output_folder helper"
      exports: ["write_tmdl_folder", "get_output_folder"]
      min_lines: 60
    - path: "src/semantic_model_generator/output/__init__.py"
      provides: "Module exports including writer functions"
      contains: "write_tmdl_folder"
    - path: "tests/output/test_writer.py"
      provides: "Tests for folder writing with dev/prod modes, watermark preservation, overwrite protection"
      min_lines: 100
  key_links:
    - from: "src/semantic_model_generator/output/writer.py"
      to: "src/semantic_model_generator/output/watermark.py"
      via: "imports watermark functions and WriteSummary"
      pattern: "from semantic_model_generator\\.output\\.watermark import"
    - from: "src/semantic_model_generator/output/writer.py"
      to: "Phase 5 generate_all_tmdl output"
      via: "accepts dict[str, str] files parameter (filename -> content)"
      pattern: "files: dict\\[str, str\\]"
    - from: "src/semantic_model_generator/output/writer.py"
      to: "pathlib.Path"
      via: "folder path manipulation and directory creation"
      pattern: "Path\\.mkdir\\(parents=True"
---

<objective>
Folder writer that writes Phase 5's generated TMDL dict to disk with dev/prod mode support, watermark-based preservation of manually-maintained files, and structured result reporting.

Purpose: This is the core output capability -- taking the in-memory TMDL semantic model and materializing it to a Fabric-compatible folder structure. Watermark detection protects manual edits from overwrite. Dev mode enables safe iteration with timestamped folders.
Output: `output/writer.py` with `write_tmdl_folder()` and `get_output_folder()`. Full TDD test suite covering dev/prod modes, watermark preservation, overwrite protection, and edge cases.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-output-layer/06-CONTEXT.md
@.planning/phases/06-output-layer/06-RESEARCH.md
@.planning/phases/06-output-layer/06-01-SUMMARY.md
@src/semantic_model_generator/output/watermark.py
@src/semantic_model_generator/tmdl/generate.py
</context>

<feature>
  <name>TMDL Folder Writer with Dev/Prod Modes and Watermark Preservation</name>
  <files>
    src/semantic_model_generator/output/writer.py
    src/semantic_model_generator/output/__init__.py
    tests/output/test_writer.py
  </files>
  <behavior>
    get_output_folder(base_path: Path, model_name: str, dev_mode: bool = True, timestamp: str | None = None) -> Path:
    - If dev_mode is True: returns base_path / "{model_name}_{timestamp}"
    - If dev_mode is False (prod): returns base_path / model_name
    - timestamp parameter: if None, generates current UTC; if provided, uses that (for testing)
    - Preserves model_name exactly (case, spaces)
    - ISO compact timestamp format: "20260210T120000Z"

    Cases:
    - get_output_folder(Path("/out"), "My Model", dev_mode=True, timestamp="20260210T120000Z") -> Path("/out/My Model_20260210T120000Z")
    - get_output_folder(Path("/out"), "My Model", dev_mode=False) -> Path("/out/My Model")

    write_tmdl_folder(
        files: dict[str, str],
        output_path: Path,
        model_name: str,
        dev_mode: bool = True,
        overwrite: bool = False,
        version: str | None = None,
        timestamp: str | None = None,
    ) -> WriteSummary:

    This is the main entry point for writing TMDL to disk.

    Step 1: Determine output folder
    - Call get_output_folder(output_path, model_name, dev_mode, timestamp)
    - Store as folder_path

    Step 2: Handle prod mode overwrite protection
    - If dev_mode=False and folder_path.exists() and overwrite=False:
      raise FileExistsError with message like "Output folder '{folder_path}' already exists. Pass overwrite=True to overwrite, or use dev mode for safe iteration."
    - If dev_mode=False and folder_path.exists() and overwrite=True: proceed (existing files checked individually via watermark)

    Step 3: Create output directory structure
    - folder_path.mkdir(parents=True, exist_ok=True)
    - (folder_path / "definition").mkdir(exist_ok=True)
    - (folder_path / "definition" / "tables").mkdir(exist_ok=True)

    Step 4: Get version for watermark
    - If version is None: import from semantic_model_generator._version import __version__; use that
    - If version is provided: use that (for testing)

    Step 5: Process each file in the dict
    - For each (relative_path, content) in files:
      - full_path = folder_path / relative_path
      - watermarked_content = add_watermark_to_content(relative_path, content, version, timestamp)
      - If full_path does not exist:
        - write_file_atomically(full_path, watermarked_content)
        - Add relative_path to written list
      - If full_path exists:
        - Read existing content: existing = full_path.read_text(encoding='utf-8')
        - If existing == watermarked_content:
          - Add relative_path to unchanged list (skip writing, byte-identical)
        - Elif is_auto_generated(existing):
          - write_file_atomically(full_path, watermarked_content)
          - Add relative_path to written list
        - Else (no watermark, manually maintained):
          - Add relative_path to skipped list (DO NOT write)

    Step 6: Return WriteSummary
    - written=tuple(sorted(written)), skipped=tuple(sorted(skipped)), unchanged=tuple(sorted(unchanged)), output_path=folder_path

    Test cases:
    - get_output_folder dev mode appends timestamp suffix
    - get_output_folder prod mode uses base model name
    - get_output_folder preserves model name case and spaces
    - get_output_folder dev mode with explicit timestamp is deterministic
    - write_tmdl_folder creates correct directory structure (definition/, definition/tables/)
    - write_tmdl_folder writes all files from dict to correct paths
    - write_tmdl_folder adds watermark to each written file
    - write_tmdl_folder dev mode creates timestamped folder
    - write_tmdl_folder prod mode creates base name folder
    - write_tmdl_folder prod mode raises FileExistsError if folder exists and overwrite=False
    - write_tmdl_folder prod mode overwrites when overwrite=True
    - write_tmdl_folder skips files without watermark (manually maintained)
    - write_tmdl_folder reports skipped files in WriteSummary
    - write_tmdl_folder overwrites files with watermark
    - write_tmdl_folder reports unchanged files when content identical
    - write_tmdl_folder does not delete extra files not in generated set
    - write_tmdl_folder creates parent directories if output_path doesn't exist
    - write_tmdl_folder returns correct WriteSummary with all categories
    - write_tmdl_folder .tmdl files have triple-slash watermark
    - write_tmdl_folder .json files have _comment watermark field
    - write_tmdl_folder .pbism files have _comment watermark field
    - write_tmdl_folder .platform files have _comment watermark field
  </behavior>
  <implementation>
    Create src/semantic_model_generator/output/writer.py with get_output_folder() and write_tmdl_folder().
    Use pathlib.Path throughout. Import watermark functions from output.watermark module (Plan 01).
    Use tmp_path pytest fixture for all tests (isolated temporary directories).
    Update src/semantic_model_generator/output/__init__.py to also export write_tmdl_folder and get_output_folder.
    Follow project conventions: functional style, explicit types, frozen dataclasses where applicable.
    All file reads/writes use encoding='utf-8' explicitly.
    Sorted results in WriteSummary for determinism.
  </implementation>
</feature>

<verification>
```bash
cd /workspaces/semantic-model-generator && python -m pytest tests/output/ -v
cd /workspaces/semantic-model-generator && make check
```
All new tests pass. All existing tests still pass. Lint + typecheck clean.
</verification>

<success_criteria>
- get_output_folder correctly computes dev (timestamped) and prod (base name) folder paths
- write_tmdl_folder writes all files from dict[str, str] to correct folder structure
- Every written file contains the appropriate watermark (triple-slash for .tmdl, _comment for .json/.pbism/.platform)
- Files with watermark are overwritten on regeneration
- Files without watermark are skipped and reported in WriteSummary.skipped
- Files with identical content are reported in WriteSummary.unchanged
- Extra files on disk are not deleted
- Prod mode raises FileExistsError when folder exists and overwrite=False
- Prod mode proceeds when overwrite=True
- Dev mode always creates new timestamped folder
- Output directory created automatically via mkdir -p
- make check passes (lint + typecheck + all tests)
</success_criteria>

<output>
After completion, create `.planning/phases/06-output-layer/06-02-SUMMARY.md`
</output>
